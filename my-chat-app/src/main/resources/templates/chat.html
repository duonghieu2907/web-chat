<!DOCTYPE html>
<html lang="en" , xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web Chat</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  </head>

  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">Welcome to Web Chat!</h1>

      <div class="card">
        <div class="card-header">
          Chat Room
          <div class="float-end">
            <button class="btn btn-success btn-sm" id="connectButton">
              Connect
            </button>
            <button
              class="btn btn-danger btn-sm"
              id="disconnectButton"
              disabled="disabled"
            >
              Disconnect
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="input-group mb-3" id="usernameSection">
            <input
              type="text"
              id="usernameInput"
              class="form-control"
              placeholder="Enter your username..."
            />
            <button class="btn btn-info" id="setUsernameButton">
              Set Username
            </button>
          </div>
          <div
            id="messages"
            class="mb-3"
            style="
              height: 300px;
              overflow-y: scroll;
              border: 1px solid #ddd;
              padding: 10px;
            "
          ></div>
          <div id="chatForm" class="input-group">
            <input
              type="text"
              id="messageInput"
              class="form-control"
              placeholder="Type your message..."
            />
            <button class="btn btn-primary" id="sendButton">Send</button>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eGYwzXvK+joP"
      crossorigin="anonymous"
    ></script>
    <script>
      var stompClient = null;
      var currentUsername = null;

      var usernameInput = document.getElementById("usernameInput");
      var setUsernameButton = document.getElementById("setUsernameButton");
      var usernameSection = document.getElementById("usernameSection");

      var messageInput = document.getElementById("messageInput");
      var sendButton = document.getElementById("sendButton");
      var messagesDiv = document.getElementById("messages");
      var connectButton = document.getElementById("connectButton");
      var disconnectButton = document.getElementById("disconnectButton");

      // Function to update UI based on connection status
      function setConnected(connected) {
        connectButton.disabled = connected;
        disconnectButton.disabled = !connected;
        messageInput.disabled = !connected;
        sendButton.disabled = !connected;
        usernameSection.style.display = connected ? "none" : "flex"; // Hide username section if connected

        if (connected) {
          messagesDiv.innerHTML = ""; // Clear messages on connect
        }
      }

      // Function to establish WebSocket connection
      function connect() {
        var username = usernameInput.value.trim();
        if (!username) {
          alert("Please enter a username!");
          return;
        }
        currentUsername = username; // Store the username

        // Use SockJS for fallback compatibility
        var socket = new SockJS("/ws"); // Matches the endpoint in WebSocketConfig
        stompClient = Stomp.over(socket);

        stompClient.connect(
          { 'username': currentUsername },
          function (frame) {
            setConnected(true);
            console.log("Connected: " + frame);

            // Send an initial message to the server to register the username
            // This will trigger the @MessageMapping("/addUser") on the server
            stompClient.send(
              "/app/addUser",
              {},
              JSON.stringify({ content: "Joined" })
            ); // Arbitrary content

            // Subscribe to the public topic to receive messages
            stompClient.subscribe("/topic/public", function (chatMessage) {
              showMessage(chatMessage.body);
            });
          },
          function (error) {
            console.error("STOMP connection error: " + error);
            setConnected(false);
            showMessage("Connection error: " + error);
            currentUsername = null;
          }
        );
      }

      // Function to disconnect WebSocket
      function disconnect() {
        if (stompClient !== null) {
          stompClient.disconnect();
        }
        setConnected(false);
        console.log("Disconnected");
        showMessage("Disconnected from chat.");
        currentUsername = null;
      }

      // Function to send message to the server
      function sendMessage() {
        var messageContent = messageInput.value.trim();
        if (messageContent && stompClient) {
          // Send message to the server's @MessageMapping("/sendMessage") endpoint
          // Sending as JSON, so the server can parse it as String or POJO.
          stompClient.send(
            "/app/sendMessage",
            {},
            JSON.stringify({ content: messageContent })
          );
          messageInput.value = ""; // Clear input field
        }
      }

      // Function to display messages in the chat window
      function showMessage(message) {
        var messageElement = document.createElement("div");
        messageElement.classList.add("message", "p-1", "rounder", "mb-1"); // Add a class for future styling

        if (message.includes("[" + currentUsername + "]:")) {
          messageElement.classList.add("bg-primary", "text-white", "ms-auto"); // Blue bg, right-alighed
        } else {
          messageElement.classList.add("bg-secondary", "text-white", "me-auto"); // Gray-gb, left aligned
        }
        messageElement.style.maxWidth = "75%";
        messageElement.textContent = message; // Use textContent for security (prevents XSS)

        messagesDiv.appendChild(messageElement);
        // Scroll to the bottom to see new messages
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      // Event Listeners for buttons and input field
      connectButton.addEventListener("click", connect);
      disconnectButton.addEventListener("click", disconnect);
      sendButton.addEventListener("click", sendMessage);

      // Allow sending message by pressing Enter key in the input field
      messageInput.addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
          event.preventDefault(); // Prevent default form submission (if any)
          sendMessage();
        }
      });

      setUsernameButton.addEventListener("click", connect);

      usernameInput.addEventListener("keypress", function (event) {
        if (event.key == "Enter") {
          event.preventDefault();
          connect();
        }
      });

      // Initialize UI state
      setConnected(false);
    </script>
  </body>
</html>
